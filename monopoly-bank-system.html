<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>–ú–æ–Ω–æ–ø–æ–ª–∏—è - –ë–∞–Ω–∫–æ–≤—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				min-height: 100vh;
				color: white;
			}

			.container {
				max-width: 400px;
				margin: 0 auto;
				padding: 10px;
				min-height: 100vh;
				display: flex;
				flex-direction: column;
			}

			.header {
				text-align: center;
				margin-bottom: 20px;
				background: rgba(255, 255, 255, 0.1);
				backdrop-filter: blur(10px);
				border-radius: 15px;
				padding: 15px;
				border: 1px solid rgba(255, 255, 255, 0.2);
			}

			.header h1 {
				font-size: 1.5rem;
				margin-bottom: 8px;
				color: #fff;
			}

			.user-info {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 10px;
				font-size: 0.9rem;
				background: rgba(255, 255, 255, 0.1);
				padding: 8px 12px;
				border-radius: 10px;
			}

			.role-selection {
				display: flex;
				gap: 10px;
				margin-bottom: 15px;
			}

			.role-btn {
				flex: 1;
				padding: 12px;
				border: none;
				border-radius: 12px;
				background: rgba(255, 255, 255, 0.2);
				color: white;
				font-size: 1rem;
				cursor: pointer;
				transition: all 0.3s ease;
				backdrop-filter: blur(10px);
				border: 2px solid transparent;
			}

			.role-btn:hover {
				background: rgba(255, 255, 255, 0.3);
				transform: translateY(-1px);
			}

			.role-btn.active {
				background: rgba(255, 255, 255, 0.4);
				border-color: rgba(255, 255, 255, 0.6);
			}

			.game-section {
				background: rgba(255, 255, 255, 0.1);
				backdrop-filter: blur(10px);
				border-radius: 15px;
				padding: 15px;
				margin-bottom: 15px;
				border: 1px solid rgba(255, 255, 255, 0.2);
			}

			.balance-display {
				text-align: center;
				font-size: 2rem;
				font-weight: bold;
				margin: 15px 0;
				color: #4ade80;
				text-shadow: 0 0 20px rgba(74, 222, 128, 0.3);
				background: rgba(74, 222, 128, 0.1);
				padding: 15px;
				border-radius: 12px;
			}

			.turn-counter {
				text-align: center;
				font-size: 1.1rem;
				margin-bottom: 15px;
				color: #fbbf24;
				background: rgba(251, 191, 36, 0.1);
				padding: 8px;
				border-radius: 8px;
			}

			.input-group {
				margin-bottom: 15px;
			}

			.input-group label {
				display: block;
				margin-bottom: 6px;
				font-weight: 500;
				font-size: 0.9rem;
			}

			.input-group input,
			.input-group select {
				width: 100%;
				padding: 12px;
				border: none;
				border-radius: 8px;
				background: rgba(255, 255, 255, 0.9);
				color: #333;
				font-size: 1rem;
				box-sizing: border-box;
			}

			.input-group input:focus,
			.input-group select:focus {
				outline: none;
				background: white;
				box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5);
			}

			.btn {
				width: 100%;
				padding: 14px;
				border: none;
				border-radius: 12px;
				background: linear-gradient(45deg, #10b981, #059669);
				color: white;
				font-size: 1rem;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s ease;
				margin-bottom: 8px;
				box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
				touch-action: manipulation;
			}

			.btn:hover,
			.btn:active {
				transform: translateY(-1px);
				box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
			}

			.btn:disabled {
				opacity: 0.6;
				cursor: not-allowed;
				transform: none;
			}

			.btn.danger {
				background: linear-gradient(45deg, #ef4444, #dc2626);
				box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
			}

			.btn.secondary {
				background: linear-gradient(45deg, #6b7280, #4b5563);
				box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);
			}

			.btn.small {
				padding: 8px 12px;
				font-size: 0.85rem;
				margin-bottom: 5px;
			}

			.qr-container {
				text-align: center;
				margin: 15px 0;
			}

			.players-list {
				max-height: 180px;
				overflow-y: auto;
				background: rgba(255, 255, 255, 0.05);
				border-radius: 8px;
				padding: 10px;
			}

			.player-item {
				display: flex;
				justify-content: space-between;
				align-items: center;
				padding: 8px 0;
				border-bottom: 1px solid rgba(255, 255, 255, 0.1);
				font-size: 0.9rem;
			}

			.player-item:last-child {
				border-bottom: none;
			}

			.status-message {
				text-align: center;
				padding: 12px;
				margin: 8px 0;
				border-radius: 8px;
				font-weight: 500;
				font-size: 0.9rem;
			}

			.status-success {
				background: rgba(16, 185, 129, 0.2);
				border: 1px solid rgba(16, 185, 129, 0.5);
				color: #10b981;
			}

			.status-error {
				background: rgba(239, 68, 68, 0.2);
				border: 1px solid rgba(239, 68, 68, 0.5);
				color: #ef4444;
			}

			.status-info {
				background: rgba(59, 130, 246, 0.2);
				border: 1px solid rgba(59, 130, 246, 0.5);
				color: #3b82f6;
			}

			.hidden {
				display: none !important;
			}

			.transaction-history {
				max-height: 120px;
				overflow-y: auto;
				background: rgba(255, 255, 255, 0.05);
				border-radius: 8px;
				padding: 10px;
				margin-top: 15px;
			}

			.transaction-item {
				display: flex;
				justify-content: space-between;
				padding: 6px 0;
				border-bottom: 1px solid rgba(255, 255, 255, 0.1);
				font-size: 0.85rem;
			}

			.transaction-item:last-child {
				border-bottom: none;
			}

			.amount-positive {
				color: #4ade80;
				font-weight: 600;
			}

			.amount-negative {
				color: #f87171;
				font-weight: 600;
			}

			.modal {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.8);
				display: flex;
				justify-content: center;
				align-items: center;
				z-index: 1000;
				padding: 20px;
			}

			.modal-content {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				padding: 20px;
				border-radius: 15px;
				max-width: 320px;
				width: 100%;
				text-align: center;
			}

			.transaction-id-display {
				background: white;
				color: black;
				padding: 15px;
				border-radius: 8px;
				text-align: center;
				margin: 8px 0;
			}

			.transaction-code {
				font-family: 'Courier New', monospace;
				font-size: 1.8rem;
				font-weight: bold;
				letter-spacing: 3px;
				margin: 12px 0;
				padding: 12px;
				background: #f0f0f0;
				border-radius: 8px;
				border: 2px dashed #666;
				color: #333;
			}

			.copy-btn {
				background: #007bff;
				color: white;
				border: none;
				padding: 8px 16px;
				border-radius: 6px;
				cursor: pointer;
				margin: 5px;
				font-size: 0.85rem;
				touch-action: manipulation;
			}

			.copy-btn:hover,
			.copy-btn:active {
				background: #0056b3;
			}

			.refresh-btn {
				background: rgba(255, 255, 255, 0.2);
				border: 1px solid rgba(255, 255, 255, 0.3);
				color: white;
				padding: 6px 10px;
				border-radius: 6px;
				cursor: pointer;
				font-size: 0.8rem;
				touch-action: manipulation;
			}

			.refresh-btn:hover,
			.refresh-btn:active {
				background: rgba(255, 255, 255, 0.3);
			}

			.auth-section {
				background: rgba(255, 255, 255, 0.1);
				border-radius: 15px;
				padding: 20px;
				margin-bottom: 15px;
				text-align: center;
			}

			.quick-amounts {
				display: grid;
				grid-template-columns: 1fr 1fr 1fr;
				gap: 8px;
				margin-bottom: 15px;
			}

			.amount-btn {
				padding: 8px;
				background: rgba(255, 255, 255, 0.2);
				border: 1px solid rgba(255, 255, 255, 0.3);
				color: white;
				border-radius: 8px;
				cursor: pointer;
				font-size: 0.9rem;
				touch-action: manipulation;
			}

			.amount-btn:hover,
			.amount-btn:active {
				background: rgba(255, 255, 255, 0.3);
			}

			.amount-btn.selected {
				background: rgba(16, 185, 129, 0.6);
				border-color: rgba(16, 185, 129, 0.8);
			}

			/* Mobile optimizations */
			@media (max-width: 480px) {
				.container {
					padding: 8px;
				}

				.header h1 {
					font-size: 1.3rem;
				}

				.balance-display {
					font-size: 1.8rem;
				}

				.transaction-code {
					font-size: 1.5rem;
					letter-spacing: 2px;
				}

				.btn {
					padding: 12px;
					font-size: 0.95rem;
				}

				.input-group input,
				.input-group select {
					padding: 10px;
					font-size: 16px; /* Prevents zoom on iOS */
				}
			}

			/* Landscape mobile */
			@media (max-height: 600px) and (orientation: landscape) {
				.container {
					padding: 5px;
				}

				.balance-display {
					margin: 10px 0;
					padding: 10px;
				}

				.transaction-history {
					max-height: 80px;
				}
			}
		</style>
	</head>
	<body>
		<div class="container">
			<!-- Auth Section -->
			<div id="authSection" class="auth-section">
				<h2>üè† –ú–æ–Ω–æ–ø–æ–ª–∏—è –ë–∞–Ω–∫</h2>
				<div class="input-group">
					<label for="playerNameAuth">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:</label>
					<input
						type="text"
						id="playerNameAuth"
						placeholder="–ò–º—è –∏–≥—Ä–æ–∫–∞"
						maxlength="20"
					/>
				</div>
				<button class="btn" id="loginBtn">–í–æ–π—Ç–∏ –≤ –∏–≥—Ä—É</button>
			</div>

			<!-- Main App -->
			<div id="mainApp" class="hidden">
				<div class="header">
					<div class="user-info">
						<span>–ò–≥—Ä–æ–∫: <strong id="currentPlayerName"></strong></span>
						<button class="refresh-btn" id="refreshBtn" title="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ">
							üîÑ
						</button>
					</div>

					<div class="role-selection">
						<button class="role-btn" id="bankerBtn">üè¶ –ë–∞–Ω–∫–∏—Ä</button>
						<button class="role-btn" id="playerBtn">üë§ –ò–≥—Ä–æ–∫</button>
					</div>
				</div>

				<!-- Banker Section -->
				<div id="bankerSection" class="game-section hidden">
					<h3>üè¶ –ü–∞–Ω–µ–ª—å –ë–∞–Ω–∫–∏—Ä–∞</h3>

					<div class="input-group">
						<label for="gameId">ID –ò–≥—Ä—ã:</label>
						<input
							type="text"
							id="gameId"
							placeholder="ID –∏–≥—Ä—ã"
							value="GAME1"
						/>
					</div>

					<button class="btn" id="createGameBtn">
						–°–æ–∑–¥–∞—Ç—å/–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∏–≥—Ä—É
					</button>

					<div id="gameControls" class="hidden">
						<div class="turn-counter">
							üéØ –•–æ–¥: <span id="currentTurn">1</span>
						</div>

						<button class="btn secondary small" id="nextTurnBtn">
							–°–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥
						</button>

						<div class="input-group">
							<label for="playerSelect">–ò–≥—Ä–æ–∫:</label>
							<select id="playerSelect">
								<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞...</option>
							</select>
						</div>

						<div class="quick-amounts">
							<button class="amount-btn" onclick="selectAmount(50)">50‚Ç¥</button>
							<button class="amount-btn" onclick="selectAmount(100)">
								100‚Ç¥
							</button>
							<button class="amount-btn" onclick="selectAmount(200)">
								200‚Ç¥
							</button>
							<button class="amount-btn" onclick="selectAmount(500)">
								500‚Ç¥
							</button>
							<button class="amount-btn" onclick="selectAmount(1000)">
								1000‚Ç¥
							</button>
							<button class="amount-btn" onclick="selectAmount(0)">
								–î—Ä—É–≥–æ–µ
							</button>
						</div>

						<div class="input-group">
							<label for="transactionAmount">–°—É–º–º–∞:</label>
							<input
								type="number"
								id="transactionAmount"
								placeholder="0"
								step="10"
							/>
						</div>

						<div class="input-group">
							<label for="transactionType">–û–ø–µ—Ä–∞—Ü–∏—è:</label>
							<select id="transactionType">
								<option value="debit">–°–ø–∏—Å–∞—Ç—å üí∏</option>
								<option value="credit">–ù–∞—á–∏—Å–ª–∏—Ç—å üí∞</option>
							</select>
						</div>

						<div class="input-group">
							<label for="transactionReason">–ü—Ä–∏—á–∏–Ω–∞:</label>
							<input
								type="text"
								id="transactionReason"
								placeholder="–ù–∞–ª–æ–≥, –ø–æ–∫—É–ø–∫–∞, –∑–∞—Ä–ø–ª–∞—Ç–∞..."
							/>
						</div>

						<button class="btn" id="createTransactionBtn">–°–æ–∑–¥–∞—Ç—å –∫–æ–¥</button>

						<div id="qrResult" class="qr-container hidden">
							<h4>–ö–æ–¥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:</h4>
							<div id="qrCodeContainer"></div>
						</div>

						<div class="players-list">
							<h4>üí∞ –ò–≥—Ä–æ–∫–∏:</h4>
							<div id="playersList"></div>
						</div>
					</div>
				</div>

				<!-- Player Section -->
				<div id="playerSection" class="game-section hidden">
					<h3>üë§ –ü–∞–Ω–µ–ª—å –ò–≥—Ä–æ–∫–∞</h3>

					<div class="input-group">
						<label for="playerGameId">ID –ò–≥—Ä—ã:</label>
						<input
							type="text"
							id="playerGameId"
							placeholder="ID –∏–≥—Ä—ã"
							value="GAME1"
						/>
					</div>

					<button class="btn" id="joinGameBtn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>

					<div id="playerControls" class="hidden">
						<div class="balance-display">
							üí∞ <span id="playerBalance">1500</span>‚Ç¥
						</div>

						<div class="turn-counter">
							üéØ –•–æ–¥: <span id="playerCurrentTurn">1</span>
						</div>

						<button class="btn secondary" id="enterCodeBtn">
							–í–≤–µ—Å—Ç–∏ –∫–æ–¥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
						</button>

						<div id="manualCodeContainer" class="input-group hidden">
							<label for="manualCodeInput">5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥:</label>
							<input
								type="text"
								id="manualCodeInput"
								placeholder="12345"
								maxlength="5"
								style="
									text-align: center;
									font-size: 1.2rem;
									letter-spacing: 2px;
								"
							/>
							<button class="btn" id="processCodeBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–¥</button>
						</div>

						<div class="transaction-history">
							<h4>üìã –ò—Å—Ç–æ—Ä–∏—è:</h4>
							<div id="transactionHistory"></div>
						</div>
					</div>
				</div>
			</div>

			<div id="statusMessage"></div>
		</div>

		<!-- Modal for confirmations -->
		<div id="confirmModal" class="modal hidden">
			<div class="modal-content">
				<h3 id="modalTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
				<p id="modalMessage"></p>
				<div id="modalTransactionInfo" class="hidden">
					<div class="transaction-id-display">
						<div class="transaction-code" id="modalTransactionCode"></div>
						<div id="modalTransactionDetails"></div>
					</div>
				</div>
				<div style="margin-top: 15px">
					<button class="btn" id="confirmBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
					<button class="btn secondary" id="cancelBtn">–û—Ç–º–µ–Ω–∞</button>
				</div>
			</div>
		</div>

		<script>
			// Enhanced storage system with user authentication
			class GameStorage {
				constructor() {
					this.data = JSON.parse(localStorage.getItem('monopoly-data') || '{}');
					this.currentUser = localStorage.getItem('monopoly-current-user');
					this.listeners = {};
				}

				setCurrentUser(userName) {
					this.currentUser = userName;
					localStorage.setItem('monopoly-current-user', userName);

					// Initialize user data if doesn't exist
					if (!this.data.users) this.data.users = {};
					if (!this.data.users[userName]) {
						this.data.users[userName] = {
							name: userName,
							createdAt: new Date().toISOString(),
							gamesJoined: [],
						};
						this.save();
					}
				}

				getCurrentUser() {
					return this.currentUser;
				}

				collection(name) {
					if (!this.data[name]) {
						this.data[name] = {};
					}
					return new Collection(name, this);
				}

				generateShortCode() {
					// Generate 5-digit code
					return Math.floor(10000 + Math.random() * 90000).toString();
				}

				save() {
					localStorage.setItem('monopoly-data', JSON.stringify(this.data));
				}

				onSnapshot(path, callback) {
					if (!this.listeners[path]) {
						this.listeners[path] = [];
					}
					this.listeners[path].push(callback);

					// Call immediately with current data
					const pathParts = path.split('/');
					let data = this.data;
					for (let part of pathParts) {
						if (data && data[part] !== undefined) {
							data = data[part];
						} else {
							data = null;
							break;
						}
					}
					callback({ exists: () => !!data, data: () => data });

					return () => {
						this.listeners[path] = this.listeners[path].filter(
							cb => cb !== callback
						);
					};
				}

				triggerListeners(path) {
					if (this.listeners[path]) {
						const pathParts = path.split('/');
						let data = this.data;
						for (let part of pathParts) {
							if (data && data[part] !== undefined) {
								data = data[part];
							} else {
								data = null;
								break;
							}
						}
						this.listeners[path].forEach(callback => {
							callback({ exists: () => !!data, data: () => data });
						});
					}
				}
			}

			class Collection {
				constructor(name, storage) {
					this.name = name;
					this.storage = storage;
				}

				doc(id) {
					return new Document(this.name, id, this.storage);
				}
			}

			class Document {
				constructor(collection, id, storage) {
					this.collection = collection;
					this.id = id;
					this.storage = storage;
				}

				async get() {
					const data = this.storage.data[this.collection]?.[this.id];
					return {
						exists: !!data,
						data: () => JSON.parse(JSON.stringify(data)), // return copy
					};
				}

				async set(data) {
					if (!this.storage.data[this.collection]) {
						this.storage.data[this.collection] = {};
					}
					// ensure dates are serialized
					const payload = {
						...data,
						createdAt: data.createdAt || new Date().toISOString(),
					};
					this.storage.data[this.collection][this.id] = payload;
					this.storage.save();
					this.storage.triggerListeners(`${this.collection}/${this.id}`);
				}

				async update(data) {
					if (!this.storage.data[this.collection]) {
						this.storage.data[this.collection] = {};
					}
					if (!this.storage.data[this.collection][this.id]) {
						this.storage.data[this.collection][this.id] = {};
					}

					Object.keys(data).forEach(key => {
						if (key.includes('.')) {
							// Handle nested updates like "players.userId.balance"
							const parts = key.split('.');
							let target = this.storage.data[this.collection][this.id];
							for (let i = 0; i < parts.length - 1; i++) {
								if (!target[parts[i]]) {
									target[parts[i]] = {};
								}
								target = target[parts[i]];
							}
							target[parts[parts.length - 1]] = data[key];
						} else {
							this.storage.data[this.collection][this.id][key] = data[key];
						}
					});

					this.storage.save();
					this.storage.triggerListeners(`${this.collection}/${this.id}`);
				}

				onSnapshot(callback) {
					return this.storage.onSnapshot(
						`${this.collection}/${this.id}`,
						callback
					);
				}
			}

			// Initialize storage
			const db = new GameStorage();

			// Global variables
			let currentGameId = null;
			let currentRole = null;
			let unsubscribeGame = null;
			let lastPreparedTransaction = null; // used for confirmation modal

			// DOM elements
			const authSection = document.getElementById('authSection');
			const mainApp = document.getElementById('mainApp');
			const bankerBtn = document.getElementById('bankerBtn');
			const playerBtn = document.getElementById('playerBtn');
			const bankerSection = document.getElementById('bankerSection');
			const playerSection = document.getElementById('playerSection');
			const statusMessage = document.getElementById('statusMessage');

			// Initialize app
			document.addEventListener('DOMContentLoaded', () => {
				// Check if user is already logged in
				const currentUser = db.getCurrentUser();
				if (currentUser) {
					document.getElementById('currentPlayerName').textContent =
						currentUser;
					authSection.classList.add('hidden');
					mainApp.classList.remove('hidden');
					showStatus('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ' + currentUser + '!', 'success');
				}

				// Auth
				document.getElementById('loginBtn').addEventListener('click', login);
				document
					.getElementById('playerNameAuth')
					.addEventListener('keypress', e => {
						if (e.key === 'Enter') login();
					});

				// Navigation
				document
					.getElementById('refreshBtn')
					.addEventListener('click', refreshData);
				bankerBtn.addEventListener('click', () => selectRole('banker'));
				playerBtn.addEventListener('click', () => selectRole('player'));

				// Banker controls
				document
					.getElementById('createGameBtn')
					.addEventListener('click', createGame);
				document
					.getElementById('nextTurnBtn')
					.addEventListener('click', nextTurn);
				document
					.getElementById('createTransactionBtn')
					.addEventListener('click', createTransaction);

				// Player controls
				document
					.getElementById('joinGameBtn')
					.addEventListener('click', joinGame);
				document
					.getElementById('enterCodeBtn')
					.addEventListener('click', toggleManualCode);
				document
					.getElementById('processCodeBtn')
					.addEventListener('click', processManualCode);
				document
					.getElementById('manualCodeInput')
					.addEventListener('input', formatCodeInput);

				// Modal controls
				document
					.getElementById('confirmBtn')
					.addEventListener('click', confirmTransaction);
				document
					.getElementById('cancelBtn')
					.addEventListener('click', closeModal);
			});

			function login() {
				const playerName = document
					.getElementById('playerNameAuth')
					.value.trim();
				if (!playerName) {
					showStatus('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è', 'error');
					return;
				}

				if (playerName.length < 2) {
					showStatus('–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞', 'error');
					return;
				}

				db.setCurrentUser(playerName);
				document.getElementById('currentPlayerName').textContent = playerName;
				authSection.classList.add('hidden');
				mainApp.classList.remove('hidden');
				showStatus('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ' + playerName + '!', 'success');
			}

			function refreshData() {
				if (currentGameId) {
					// Trigger refresh of game data
					db.triggerListeners(`games/${currentGameId}`);
					updatePlayerBalance();
					updateTransactionHistory();
					showStatus('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'info');
				} else {
					showStatus('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –∏–≥—Ä–µ', 'error');
				}
			}

			function selectRole(role) {
				currentRole = role;

				// Update UI
				document
					.querySelectorAll('.role-btn')
					.forEach(btn => btn.classList.remove('active'));
				if (role === 'banker') {
					bankerBtn.classList.add('active');
					bankerSection.classList.remove('hidden');
					playerSection.classList.add('hidden');
				} else {
					playerBtn.classList.add('active');
					playerSection.classList.remove('hidden');
					bankerSection.classList.add('hidden');
				}
			}

			function selectAmount(amount) {
				// try to get event target (works for inline onclick in many browsers)
				const ev = window.event || null;
				document
					.querySelectorAll('.amount-btn')
					.forEach(btn => btn.classList.remove('selected'));
				if (ev && ev.target && ev.target.classList.contains('amount-btn')) {
					ev.target.classList.add('selected');
				} else {
					// fallback: select button with matching text
					const btn = Array.from(document.querySelectorAll('.amount-btn')).find(
						b =>
							b.textContent.includes(
								amount && amount !== 0 ? amount.toString() : '–î—Ä—É–≥–æ–µ'
							)
					);
					if (btn) btn.classList.add('selected');
				}

				// Set amount
				const amountInput = document.getElementById('transactionAmount');
				if (amount === 0) {
					amountInput.value = '';
					amountInput.focus();
				} else {
					amountInput.value = amount;
				}
			}

			function showStatus(message, type) {
				const statusDiv = document.getElementById('statusMessage');
				statusDiv.textContent = message;
				statusDiv.className = `status-message status-${type}`;

				// Auto-hide after 4 seconds
				setTimeout(() => {
					statusDiv.textContent = '';
					statusDiv.className = '';
				}, 4000);
			}

			// Banker functions
			async function createGame() {
				const gameId = document
					.getElementById('gameId')
					.value.trim()
					.toUpperCase();
				if (!gameId) {
					showStatus('–í–≤–µ–¥–∏—Ç–µ ID –∏–≥—Ä—ã', 'error');
					return;
				}

				try {
					const gameRef = db.collection('games').doc(gameId);
					const gameDoc = await gameRef.get();
					const currentUser = db.getCurrentUser();
					if (!currentUser) {
						showStatus('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
						return;
					}

					if (!gameDoc.exists) {
						// Create new game
						await gameRef.set({
							createdAt: new Date().toISOString(),
							currentTurn: 1,
							bankerId: currentUser,
							bankerName: currentUser,
							players: {},
							transactions: [],
						});
						showStatus('–ò–≥—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞!', 'success');
					} else {
						showStatus('–ü–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –∏–≥—Ä–µ', 'info');
					}

					currentGameId = gameId;
					document.getElementById('gameControls').classList.remove('hidden');

					// Subscribe to game updates
					subscribeToGame();
				} catch (error) {
					showStatus('–û—à–∏–±–∫–∞: ' + (error.message || error), 'error');
				}
			}

			async function nextTurn() {
				if (!currentGameId) {
					showStatus('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –∏–≥—Ä–µ', 'error');
					return;
				}
				const gameRef = db.collection('games').doc(currentGameId);
				const gameDoc = await gameRef.get();
				if (!gameDoc.exists) {
					showStatus('–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
					return;
				}

				const gameData = gameDoc.data();
				const next = (gameData.currentTurn || 1) + 1;
				await gameRef.update({ currentTurn: next });
				showStatus('–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥: ' + next, 'info');
			}

			async function createTransaction() {
				if (!currentGameId) {
					showStatus('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –∏–≥—Ä–µ', 'error');
					return;
				}

				const playerId = document.getElementById('playerSelect').value;
				const amount = Number(
					document.getElementById('transactionAmount').value
				);
				const type = document.getElementById('transactionType').value;
				const reason =
					document.getElementById('transactionReason').value.trim() ||
					'–ë–µ–∑ –ø—Ä–∏—á–∏–Ω—ã';

				if (!playerId) {
					showStatus('–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞', 'error');
					return;
				}
				if (!amount || amount <= 0) {
					showStatus('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É', 'error');
					return;
				}

				const gameRef = db.collection('games').doc(currentGameId);
				const gameDoc = await gameRef.get();
				if (!gameDoc.exists) {
					showStatus('–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
					return;
				}

				// Create transaction object
				const code = db.generateShortCode();
				const tx = {
					code,
					playerId,
					amount,
					type,
					reason,
					createdAt: new Date().toISOString(),
					applied: false,
					appliedAt: null,
					banker: db.getCurrentUser(),
				};

				// append to transactions
				const gameData = gameDoc.data();
				const transactions = Array.isArray(gameData.transactions)
					? gameData.transactions.slice()
					: [];
				transactions.push(tx);

				// save
				await gameRef.update({ transactions });
				showStatus('–ö–æ–¥ —Å–æ–∑–¥–∞–Ω: ' + code, 'success');

				// show code in UI
				const qrResult = document.getElementById('qrResult');
				const qrContainer = document.getElementById('qrCodeContainer');
				qrContainer.innerHTML = `
                <div class="transaction-id-display">
                    <div class="transaction-code">${code}</div>
                    <div style="color:#111; padding:8px; border-radius:6px; background:#fff; margin-top:8px;">
                        ${
													type === 'debit' ? '–°–ø–∏—Å–∞—Ç—å' : '–ù–∞—á–∏—Å–ª–∏—Ç—å'
												} ${amount}‚Ç¥ ‚Äî ${reason}
                    </div>
                    <div style="margin-top:8px;">
                        <button class="copy-btn" id="copyCodeBtn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
                    </div>
                </div>
            `;
				qrResult.classList.remove('hidden');

				// attach copy
				setTimeout(() => {
					const cbtn = document.getElementById('copyCodeBtn');
					if (cbtn) {
						cbtn.addEventListener('click', () => {
							navigator.clipboard
								?.writeText(code)
								.then(() => {
									showStatus('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
								})
								.catch(() => {
									showStatus('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥', 'error');
								});
						});
					}
				}, 10);
			}

			// Player functions
			async function joinGame() {
				const gameId = document
					.getElementById('playerGameId')
					.value.trim()
					.toUpperCase();
				if (!gameId) {
					showStatus('–í–≤–µ–¥–∏—Ç–µ ID –∏–≥—Ä—ã', 'error');
					return;
				}
				const currentUser = db.getCurrentUser();
				if (!currentUser) {
					showStatus('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
					return;
				}

				const gameRef = db.collection('games').doc(gameId);
				const gameDoc = await gameRef.get();
				let gameData = gameDoc.exists ? gameDoc.data() : null;

				if (!gameData) {
					// create minimal game if doesn't exist (player can join)
					gameData = {
						createdAt: new Date().toISOString(),
						currentTurn: 1,
						bankerId: null,
						bankerName: null,
						players: {},
						transactions: [],
					};
					await gameRef.set(gameData);
				}

				// add player if new
				if (!gameData.players) gameData.players = {};
				if (!gameData.players[currentUser]) {
					gameData.players[currentUser] = {
						id: currentUser,
						name: currentUser,
						balance: 1500,
						createdAt: new Date().toISOString(),
						history: [],
					};
					await gameRef.update({ players: gameData.players });
				}

				currentGameId = gameId;
				document.getElementById('playerControls').classList.remove('hidden');
				showStatus('–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∏–≥—Ä–µ ' + gameId, 'success');

				// subscribe to game updates
				subscribeToGame();
			}

			function toggleManualCode() {
				const manual = document.getElementById('manualCodeContainer');
				manual.classList.toggle('hidden');
				if (!manual.classList.contains('hidden')) {
					document.getElementById('manualCodeInput').focus();
				}
			}

			function formatCodeInput(e) {
				// allow only digits, max length 5
				const el = e.target;
				el.value = el.value.replace(/\D/g, '').slice(0, 5);
			}

			async function processManualCode() {
				const code = document.getElementById('manualCodeInput').value.trim();
				if (code.length !== 5) {
					showStatus('–í–≤–µ–¥–∏—Ç–µ 5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥', 'error');
					return;
				}
				if (!currentGameId) {
					showStatus('–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ –∏–≥—Ä–µ', 'error');
					return;
				}

				const gameRef = db.collection('games').doc(currentGameId);
				const gameDoc = await gameRef.get();
				if (!gameDoc.exists) {
					showStatus('–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
					return;
				}

				const gameData = gameDoc.data();
				const tx = (gameData.transactions || []).find(t => t.code === code);
				if (!tx) {
					showStatus('–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
					return;
				}
				if (tx.applied) {
					showStatus('–ö–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω', 'error');
					return;
				}

				// check that player matches or banker allowed? Here only target player can apply code
				const currentUser = db.getCurrentUser();
				if (tx.playerId !== currentUser) {
					showStatus('–≠—Ç–æ—Ç –∫–æ–¥ –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –≤–∞—Å', 'error');
					return;
				}

				// prepare confirmation modal
				lastPreparedTransaction = { ...tx };
				openModalForTransaction(lastPreparedTransaction);
			}

			// Modal helpers
			function openModalForTransaction(tx) {
				document.getElementById('modalTitle').textContent =
					'–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é';
				document.getElementById(
					'modalMessage'
				).textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${
					tx.type === 'debit' ? '—Å–ø–∏—Å–∞—Ç—å' : '–Ω–∞—á–∏—Å–ª–∏—Ç—å'
				} ${tx.amount}‚Ç¥?`;
				document
					.getElementById('modalTransactionInfo')
					.classList.remove('hidden');
				document.getElementById('modalTransactionCode').textContent = tx.code;
				document.getElementById('modalTransactionDetails').innerHTML = `
                ${tx.type === 'debit' ? '–°–ø–∏—Å–∞–Ω–∏–µ' : '–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ'} ‚Äî ${
					tx.amount
				}‚Ç¥<br>
                –ü—Ä–∏—á–∏–Ω–∞: ${tx.reason}<br>
                –ë–∞–Ω–∫–∏—Ä: ${tx.banker || '‚Äî'}
            `;
				document.getElementById('confirmModal').classList.remove('hidden');
			}

			function closeModal() {
				document.getElementById('confirmModal').classList.add('hidden');
				lastPreparedTransaction = null;
			}

			async function confirmTransaction() {
				if (!lastPreparedTransaction) {
					closeModal();
					return;
				}
				if (!currentGameId) {
					showStatus('–ò–≥—Ä–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞', 'error');
					closeModal();
					return;
				}

				try {
					const gameRef = db.collection('games').doc(currentGameId);
					const gameDoc = await gameRef.get();
					const gameData = gameDoc.exists ? gameDoc.data() : null;
					if (!gameData) {
						showStatus('–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
						closeModal();
						return;
					}

					const txs = Array.isArray(gameData.transactions)
						? gameData.transactions.slice()
						: [];
					const txIndex = txs.findIndex(
						t => t.code === lastPreparedTransaction.code
					);
					if (txIndex === -1) {
						showStatus('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
						closeModal();
						return;
					}

					const tx = txs[txIndex];
					if (tx.applied) {
						showStatus('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞', 'error');
						closeModal();
						return;
					}

					const playerId = tx.playerId;
					if (!gameData.players || !gameData.players[playerId]) {
						showStatus('–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
						closeModal();
						return;
					}

					// apply
					const players = { ...gameData.players };
					if (tx.type === 'debit') {
						players[playerId].balance =
							Number(players[playerId].balance) - Number(tx.amount);
					} else {
						players[playerId].balance =
							Number(players[playerId].balance) + Number(tx.amount);
					}

					// clamp to integer
					players[playerId].balance = Math.round(players[playerId].balance);

					// mark transaction applied
					txs[txIndex] = {
						...tx,
						applied: true,
						appliedAt: new Date().toISOString(),
						appliedBy: db.getCurrentUser(),
					};

					// add history entry to player
					if (!players[playerId].history) players[playerId].history = [];
					players[playerId].history.unshift({
						code: tx.code,
						amount: tx.amount,
						type: tx.type,
						reason: tx.reason,
						date: new Date().toISOString(),
						banker: tx.banker || null,
					});

					// update storage
					await gameRef.update({ players, transactions: txs });

					showStatus('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞', 'success');
					updatePlayerBalance();
					updateTransactionHistory();
				} catch (err) {
					showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è: ' + (err.message || err), 'error');
				} finally {
					closeModal();
				}
			}

			// Subscribe to game changes
			function subscribeToGame() {
				if (!currentGameId) return;
				// Unsubscribe previous
				if (typeof unsubscribeGame === 'function') {
					unsubscribeGame();
					unsubscribeGame = null;
				}

				const gameRef = db.collection('games').doc(currentGameId);
				unsubscribeGame = gameRef.onSnapshot(snapshot => {
					if (!snapshot.exists()) {
						showStatus('–ò–≥—Ä–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
						return;
					}
					const gameData = snapshot.data() || {};
					// update UI elements that depend on game state
					document.getElementById('currentTurn').textContent =
						gameData.currentTurn || 1;
					document.getElementById('playerCurrentTurn').textContent =
						gameData.currentTurn || 1;

					// players list
					updatePlayersList(
						gameData.players || {},
						gameData.transactions || []
					);

					// if player view, update balance and history
					updatePlayerBalance(gameData.players || {});
					updateTransactionHistory(
						gameData.transactions || [],
						gameData.players || {}
					);
				});
			}

			// Update players list on banker panel
			function updatePlayersList(players = {}, transactions = []) {
				const playersList = document.getElementById('playersList');
				const playerSelect = document.getElementById('playerSelect');

				const keys = Object.keys(players || {});
				playerSelect.innerHTML = `<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞...</option>`;
				playersList.innerHTML = '';

				keys.forEach(pid => {
					const p = players[pid];
					const item = document.createElement('div');
					item.className = 'player-item';
					item.innerHTML = `
                    <div>
                        <strong>${p.name}</strong><br><small>${p.balance}‚Ç¥</small>
                    </div>
                    <div style="text-align:right;">
                        <button class="refresh-btn" onclick="copyPlayerId('${pid}')">ID</button>
                    </div>
                `;
					playersList.appendChild(item);

					const opt = document.createElement('option');
					opt.value = pid;
					opt.textContent = `${p.name} ‚Äî ${p.balance}‚Ç¥`;
					playerSelect.appendChild(opt);
				});

				// annotate players who have pending transactions
				if (transactions && transactions.length) {
					const pendingCounts = {};
					transactions.forEach(t => {
						if (!t.applied)
							pendingCounts[t.playerId] = (pendingCounts[t.playerId] || 0) + 1;
					});

					// add badges in select text (simple)
					Array.from(playerSelect.options).forEach(opt => {
						if (opt.value && pendingCounts[opt.value]) {
							opt.textContent += ` (‚óè${pendingCounts[opt.value]})`;
						}
					});
				}
			}

			function copyPlayerId(id) {
				navigator.clipboard
					?.writeText(id)
					.then(() => {
						showStatus('ID –∏–≥—Ä–æ–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω', 'info');
					})
					.catch(() => {
						showStatus('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID', 'error');
					});
			}

			// Update player balance in player panel
			async function updatePlayerBalance(playersData) {
				if (!currentGameId) return;
				const currentUser = db.getCurrentUser();
				if (!currentUser) return;

				const gameRef = db.collection('games').doc(currentGameId);
				const gameDoc = await gameRef.get();
				if (!gameDoc.exists) return;
				const gameData = gameDoc.data();

				const players =
					playersData && Object.keys(playersData).length
						? playersData
						: gameData.players || {};
				const playerObj = players[currentUser];
				if (playerObj) {
					document.getElementById('playerBalance').textContent =
						playerObj.balance;
				}
			}

			// Update transaction history on player panel
			async function updateTransactionHistory(transactions, playersData) {
				if (!currentGameId) return;
				const currentUser = db.getCurrentUser();
				if (!currentUser) return;

				const gameRef = db.collection('games').doc(currentGameId);
				const gameDoc = await gameRef.get();
				if (!gameDoc.exists) return;
				const gameData = gameDoc.data();

				const txs = Array.isArray(transactions)
					? transactions.slice()
					: gameData.transactions || [];
				const players =
					playersData && Object.keys(playersData).length
						? playersData
						: gameData.players || {};

				// Prefer player's own history if present
				let history = [];
				if (
					players[currentUser] &&
					Array.isArray(players[currentUser].history)
				) {
					history = players[currentUser].history.slice(0, 30);
				} else {
					// fallback: filter global transactions
					history = txs
						.filter(t => t.playerId === currentUser)
						.map(t => ({
							code: t.code,
							amount: t.amount,
							type: t.type,
							reason: t.reason,
							date: t.appliedAt || t.createdAt,
							applied: t.applied,
						}))
						.slice()
						.reverse();
				}

				const container = document.getElementById('transactionHistory');
				container.innerHTML = '';
				if (history.length === 0) {
					container.innerHTML = '<div style="opacity:0.8">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div>';
					return;
				}
				history.forEach(h => {
					const el = document.createElement('div');
					el.className = 'transaction-item';
					el.innerHTML = `
                    <div style="max-width:65%">${
											h.type === 'debit' ? '–°–ø–∏—Å–∞–Ω–∏–µ' : '–ó–∞—á–∏—Å–ª–µ–Ω–∏–µ'
										} ${h.reason || ''}<br><small>${new Date(
						h.date
					).toLocaleString()}</small></div>
                    <div style="text-align:right" class="${
											h.type === 'credit'
												? 'amount-positive'
												: 'amount-negative'
										}">${h.type === 'credit' ? '+' : '-'}${h.amount}‚Ç¥</div>
                `;
					container.appendChild(el);
				});
			}
		</script>
	</body>
</html>
